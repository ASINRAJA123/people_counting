<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>People Counting Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">People Counting Dashboard</h1>
            <div class="flex items-center space-x-2">
                <label for="date-picker" class="text-sm font-medium text-white">Select Date:</label>
                <input type="date" id="date-picker" value="{{ today_date }}" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2">
            </div>
        </header>

        <!-- Overall Counts Section -->
        <div class="mb-10">
            <h2 class="text-2xl font-semibold text-gray-300 mb-4 text-center">Overall Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 text-center">
                    <h3 class="text-xl font-semibold text-white">TOTAL PEOPLE IN</h3>
                    <p id="overall-in-count" class="text-7xl font-extrabold text-green-400 mt-2">0</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 text-center">
                    <h3 class="text-xl font-semibold text-white">TOTAL PEOPLE OUT</h3>
                    <p id="overall-out-count" class="text-7xl font-extrabold text-red-400 mt-2">0</p>
                </div>
            </div>
        </div>

        <!-- Divider -->
        <hr class="border-slate-700 my-8">

        <!-- Individual Hall Counts Section -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-300 mb-4 text-center">Individual Hall Counts</h2>
            <!-- KEY CHANGE HERE: The grid is now set to 3 columns on medium screens and up -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Cards will be generated by Jinja and updated by JS -->
                {% for name in hall_names %}
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border-2 border-slate-700 text-center flex flex-col justify-between">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">{{ name.replace('_', ' ') | title }}</h3>
                    <div class="flex justify-around items-center">
                        <div>
                            <h4 class="text-md font-semibold text-white">IN</h4>
                            <p id="hall-{{ name }}-in" class="text-5xl font-bold text-green-400">0</p>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold text-white">OUT</h4>
                            <p id="hall-{{ name }}-out" class="text-5xl font-bold text-red-400">0</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const LIVE_POLL_INTERVAL_MS = 2000; // Polling can be slightly less frequent
            const datePicker = document.getElementById('date-picker');
            
            // Store hall names from the template to use in the fetch loop
            const hallNames = [{% for name in hall_names %}"{{ name }}",{% endfor %}];
            let livePollIntervalId = null;

            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            async function fetchDataForDate() {
                const selectedDate = datePicker.value;

                try {
                    // The API now returns all data in one call
                    const response = await fetch(`/api/data?date=${selectedDate}`);
                    if (!response.ok) {
                        console.error("Failed to fetch data from API");
                        return;
                    }
                    
                    const data = await response.json();

                    // Update Overall Counts
                    const overallInEl = document.getElementById('overall-in-count');
                    const overallOutEl = document.getElementById('overall-out-count');
                    overallInEl.textContent = data.overall.in_count;
                    overallOutEl.textContent = data.overall.out_count;

                    // Update Individual Hall Counts
                    hallNames.forEach(hallName => {
                        const hallData = data.halls[hallName] || { in_count: 0, out_count: 0 };
                        const hallInEl = document.getElementById(`hall-${hallName}-in`);
                        const hallOutEl = document.getElementById(`hall-${hallName}-out`);
                        
                        if (hallInEl) hallInEl.textContent = hallData.in_count;
                        if (hallOutEl) hallOutEl.textContent = hallData.out_count;
                    });

                } catch (error) { 
                    console.error("Failed to fetch or parse data:", error);
                }

                // Manage polling based on whether today is selected
                if (selectedDate === getTodayDateString()) {
                    startLivePolling();
                } else {
                    stopLivePolling();
                }
            }
            
            function stopLivePolling() {
                if (livePollIntervalId) {
                    clearInterval(livePollIntervalId);
                    livePollIntervalId = null;
                }
            }

            function startLivePolling() {
                stopLivePolling(); // Prevent multiple intervals
                livePollIntervalId = setInterval(fetchDataForDate, LIVE_POLL_INTERVAL_MS);
            }
            
            datePicker.addEventListener('change', fetchDataForDate);

            // Fetch initial data on page load
            fetchDataForDate();
        });
    </script>
</body>
</html>